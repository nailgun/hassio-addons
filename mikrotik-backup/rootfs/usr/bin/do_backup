#!/usr/bin/with-contenv bashio

set -euo pipefail

function _ssh() {
    ssh -n "$@" | sed s/.$//
}

bashio::log.info "Pulling repo changes..."
git -C "/data/repo" pull

ssh_host_args="$(bashio::config ssh_host_args)"

echo "$ssh_host_args" | while read -r host_args; do
  bashio::log.info "SSH: $host_args"

  # shellcheck disable=SC2086
  ident="$(_ssh $host_args 'put [/system identity print as-value]')"
  if [[ ! "$ident" =~ ^name=(.*)$ ]]; then
      echo "Invalid identity output: '$ident'" >&2
      exit 1
  fi
  ident="${BASH_REMATCH[1]}"

  bashio::log.info "  ident: $ident"

  # shellcheck disable=SC2086
  _ssh $host_args /export | sed '1 s/#.* by/# by/' > "/data/repo/mikrotik/$ident.rsc" || true

  git -C "/data/repo" add "/data/repo/mikrotik/$ident.rsc"
  git -C "/data/repo" commit --message="Mikrotik backup: $ident" || true
done

bashio::log.info "Pushing repo..."
git -C "/data/repo" push
